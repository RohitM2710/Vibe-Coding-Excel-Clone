<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSpread AI - Enhanced Excel Clone</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            height: 100vh;
            background-color: #f3f4f6;
        }

        .grid-container {
            display: grid;
            grid-template-columns: 40px repeat(26, 120px);
            overflow: auto;
            height: calc(100vh - 140px);
            background-color: #e5e7eb;
            gap: 1px;
        }

        .cell {
            background-color: white;
            padding: 4px 8px;
            font-size: 13px;
            border: 0.5px solid #e5e7eb;
            outline: none;
            white-space: nowrap;
            overflow: hidden;
            height: 25px;
            display: flex;
            align-items: center;
        }

        .cell:focus {
            border: 2px solid #217346;
            z-index: 10;
        }

        .header-cell {
            background-color: #f3f4f6;
            color: #6b7280;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 20;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 0.5px solid #d1d5db;
        }

        .row-header {
            position: sticky;
            left: 0;
            z-index: 30;
            background-color: #f3f4f6;
        }

        .top-left-corner {
            position: sticky;
            top: 0;
            left: 0;
            z-index: 40;
            background-color: #f3f4f6;
        }

        .toolbar-btn {
            padding: 6px;
            border-radius: 4px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .toolbar-btn:hover {
            background-color: #e5e7eb;
        }

        .ai-btn {
            background-color: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        
        .ai-btn:hover {
            background-color: #dcfce7;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body class="flex flex-col">

    <!-- AI Modal -->
    <div id="ai-modal" class="modal">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg w-full">
            <h3 class="text-lg font-bold mb-2 flex items-center gap-2">
                ✨ Gemini AI Insights
            </h3>
            <div id="ai-content" class="text-sm text-gray-700 whitespace-pre-wrap max-h-96 overflow-auto border p-3 rounded bg-gray-50 mb-4">
                Analyzing your data...
            </div>
            <div class="flex justify-end">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 rounded text-sm hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>

    <!-- Ribbon / Toolbar -->
    <header class="bg-white border-b border-gray-300">
        <div class="bg-[#217346] text-white px-4 py-1 text-sm flex items-center justify-between">
            <div class="flex items-center gap-4">
                <span class="font-bold">WebSpread AI</span>
                <span class="opacity-80">Book1 - Auto-saved</span>
            </div>
            <div class="flex gap-2">
                <button onclick="analyzeSheet()" class="toolbar-btn ai-btn text-xs font-bold py-1 px-3">
                    ✨ Analyze Data
                </button>
            </div>
        </div>
        
        <!-- Menu Tabs -->
        <div class="flex text-xs px-2 border-b border-gray-200">
            <button class="px-3 py-2 border-b-2 border-[#217346] font-semibold">Home</button>
            <button class="px-3 py-2 hover:bg-gray-100">AI Assistant</button>
            <button class="px-3 py-2 hover:bg-gray-100">Data Tools</button>
        </div>

        <!-- Formatting Toolbar -->
        <div class="flex items-center gap-2 p-2 bg-[#f9f9f9]">
            <div class="flex border-r border-gray-300 pr-2 mr-2">
                <button onclick="applyStyle('bold')" class="toolbar-btn" title="Bold">
                    <i data-lucide="bold" class="w-4 h-4"></i>
                </button>
                <button onclick="applyStyle('italic')" class="toolbar-btn" title="Italic">
                    <i data-lucide="italic" class="w-4 h-4"></i>
                </button>
            </div>
            <div class="flex border-r border-gray-300 pr-2 mr-2">
                <button onclick="applyAlign('left')" class="toolbar-btn">
                    <i data-lucide="align-left" class="w-4 h-4"></i>
                </button>
                <button onclick="applyAlign('center')" class="toolbar-btn">
                    <i data-lucide="align-center" class="w-4 h-4"></i>
                </button>
            </div>
            <div class="flex gap-2">
                <button onclick="smartFill()" class="toolbar-btn ai-btn text-xs" title="Predict current row values">
                    ✨ Smart Fill
                </button>
                <button onclick="askFormula()" class="toolbar-btn ai-btn text-xs" title="Ask Gemini for a formula">
                    ✨ Write Formula
                </button>
            </div>
        </div>
    </header>

    <!-- Formula Bar -->
    <div class="flex items-center bg-white border-b border-gray-300 p-1 px-4 gap-2">
        <div id="active-cell-id" class="text-sm font-medium text-gray-500 w-10 text-center">A1</div>
        <div class="h-6 w-[1px] bg-gray-300"></div>
        <div class="text-italic text-gray-400 px-2 font-serif">fx</div>
        <input type="text" id="formula-bar" class="flex-1 text-sm outline-none" placeholder="Enter text or formula (e.g. =A1+B1)">
    </div>

    <!-- Main Spreadsheet Grid -->
    <main id="spreadsheet" class="grid-container">
        <!-- Generated by JS -->
    </main>

    <!-- Footer / Tabs -->
    <footer class="bg-white border-t border-gray-300 flex items-center justify-between px-4 py-1 text-xs text-gray-600">
        <div class="flex items-center gap-4">
            <div class="flex items-center bg-gray-100 rounded px-2 py-1 gap-2 border border-gray-200">
                <i data-lucide="sheet" class="w-3 h-3 text-[#217346]"></i>
                <span class="font-bold">Sheet1</span>
            </div>
        </div>
        <div id="status-bar" class="flex gap-4">
            <span id="ai-status">Ready</span>
            <span class="flex items-center gap-1"><i data-lucide="plus" class="w-3 h-3"></i> 100%</span>
        </div>
    </footer>

    <script>
        const apiKey = ""; // Provided by environment
        const ROWS = 50;
        const COLS = 26;
        const grid = document.getElementById('spreadsheet');
        const formulaBar = document.getElementById('formula-bar');
        const activeCellDisplay = document.getElementById('active-cell-id');
        const statusText = document.getElementById('ai-status');
        
        let activeCell = null;
        const cellData = {}; 

        lucide.createIcons();

        function getColLetter(n) { return String.fromCharCode(65 + n); }

        function initGrid() {
            const corner = document.createElement('div');
            corner.className = 'top-left-corner border-r border-b border-gray-300';
            grid.appendChild(corner);

            for (let i = 0; i < COLS; i++) {
                const header = document.createElement('div');
                header.className = 'header-cell';
                header.textContent = getColLetter(i);
                grid.appendChild(header);
            }

            for (let r = 1; r <= ROWS; r++) {
                const rowHeader = document.createElement('div');
                rowHeader.className = 'header-cell row-header';
                rowHeader.textContent = r;
                grid.appendChild(rowHeader);

                for (let c = 0; c < COLS; c++) {
                    const colLetter = getColLetter(c);
                    const cellId = `${colLetter}${r}`;
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.id = cellId;
                    cell.contentEditable = true;
                    cell.addEventListener('focus', () => onCellFocus(cell));
                    cell.addEventListener('blur', () => onCellBlur(cell));
                    cell.addEventListener('input', () => onCellInput(cell));
                    cell.addEventListener('keydown', handleKeyDown);
                    grid.appendChild(cell);
                }
            }
        }

        function onCellFocus(cell) {
            activeCell = cell;
            activeCellDisplay.textContent = cell.id;
            formulaBar.value = cellData[cell.id]?.formula || cell.textContent;
        }

        function onCellBlur(cell) {
            const val = cell.textContent.trim();
            if (val.startsWith('=')) {
                cellData[cell.id] = { ...cellData[cell.id], formula: val };
                evaluateFormula(cell, val);
            } else {
                cellData[cell.id] = { ...cellData[cell.id], formula: null, value: val };
            }
        }

        function onCellInput(cell) {
            formulaBar.value = cell.textContent;
        }

        formulaBar.addEventListener('input', (e) => {
            if (activeCell) activeCell.textContent = e.target.value;
        });

        function handleKeyDown(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                activeCell.blur();
                const currentId = activeCell.id;
                const col = currentId.match(/[A-Z]+/)[0];
                const row = parseInt(currentId.match(/\d+/)[0]);
                const nextCell = document.getElementById(`${col}${row + 1}`);
                if (nextCell) nextCell.focus();
            }
        }

        function evaluateFormula(cell, formula) {
            try {
                let expression = formula.substring(1).toUpperCase();
                const cellRefRegex = /([A-Z]+)(\d+)/g;
                expression = expression.replace(cellRefRegex, (match) => {
                    const ref = document.getElementById(match);
                    return ref ? (parseFloat(ref.textContent) || 0) : 0;
                });
                const result = eval(expression);
                cell.textContent = result;
            } catch (err) {
                cell.textContent = '#ERROR!';
            }
        }

        // --- GEMINI INTEGRATIONS ---

        async function callGemini(prompt, systemPrompt = "You are a helpful spreadsheet assistant.") {
            statusText.textContent = "✨ Thinking...";
            let retries = 5;
            let delay = 1000;

            while (retries > 0) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        })
                    });
                    const data = await response.json();
                    statusText.textContent = "Ready";
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (error) {
                    retries--;
                    if (retries === 0) {
                        statusText.textContent = "Error";
                        showModal("Communication Error", "Failed to reach AI. Please try again.");
                        return null;
                    }
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2;
                }
            }
        }

        async function analyzeSheet() {
            const snapshot = getSheetSnapshot();
            const prompt = `Here is a summary of the current spreadsheet data:\n${JSON.stringify(snapshot)}\n\nPlease provide 3-5 high-level insights, trends, or observations about this data. Keep it concise.`;
            const analysis = await callGemini(prompt, "You are a data analyst. Review spreadsheet data and provide bulleted insights.");
            if (analysis) showModal("Sheet Analysis", analysis);
        }

        async function smartFill() {
            if (!activeCell) return;
            const rowNum = activeCell.id.match(/\d+/)[0];
            const context = getRowContext(rowNum);
            const prompt = `The user is filling out a spreadsheet. For row ${rowNum}, they have these values: ${JSON.stringify(context)}. Predict what the value should be for cell ${activeCell.id}. Only return the value, no explanation. If it's a list like 'Apples', 'Oranges', suggest the next item. If it's data like 'Name: John', 'Email: ?', suggest a likely email.`;
            
            const prediction = await callGemini(prompt);
            if (prediction) {
                activeCell.textContent = prediction.trim();
                activeCell.blur();
            }
        }

        async function askFormula() {
            const query = prompt("What do you want this formula to do? (e.g., 'Add A1 and B1', 'Calculate average of A1 to A10')");
            if (!query) return;

            const promptText = `Generate a spreadsheet formula for the following request: "${query}". Format the output as exactly one line starting with =. For example: =SUM(A1:A10).`;
            const result = await callGemini(promptText, "You convert natural language into spreadsheet formulas.");
            
            if (result && result.startsWith('=')) {
                formulaBar.value = result.trim();
                if (activeCell) {
                    activeCell.textContent = result.trim();
                    activeCell.focus();
                }
            }
        }

        function getSheetSnapshot() {
            const data = {};
            for (let r = 1; r <= 10; r++) { // Limit for prompt size
                for (let c = 0; c < 5; c++) {
                    const id = getColLetter(c) + r;
                    const val = document.getElementById(id).textContent;
                    if (val) data[id] = val;
                }
            }
            return data;
        }

        function getRowContext(row) {
            const rowData = {};
            for (let c = 0; c < COLS; c++) {
                const id = getColLetter(c) + row;
                const val = document.getElementById(id).textContent;
                if (val && id !== activeCell.id) rowData[id] = val;
            }
            return rowData;
        }

        function showModal(title, content) {
            document.querySelector('#ai-modal h3').innerHTML = `✨ ${title}`;
            document.getElementById('ai-content').textContent = content;
            document.getElementById('ai-modal').style.display = 'flex';
        }

        window.closeModal = function() {
            document.getElementById('ai-modal').style.display = 'none';
        }

        // Toolbar Actions
        window.applyStyle = function(style) {
            if (!activeCell) return;
            if (style === 'bold') activeCell.style.fontWeight = activeCell.style.fontWeight === 'bold' ? 'normal' : 'bold';
            if (style === 'italic') activeCell.style.fontStyle = activeCell.style.fontStyle === 'italic' ? 'normal' : 'italic';
        };

        window.applyAlign = function(align) {
            if (!activeCell) return;
            activeCell.style.justifyContent = align === 'center' ? 'center' : (align === 'right' ? 'flex-end' : 'flex-start');
            activeCell.style.textAlign = align;
        };

        initGrid();
    </script>
</body>
</html>